<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Promise基础用法</title>
    <script>
        function ajax(obj) {
            let xhr = new XMLHttpRequest();
            xhr.open('get', obj.url, true);
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    let data = (JSON.parse(xhr.responseText));
                    if(data.isOk === false){
                        obj.fail ? obj.fail(data): null;
                    }else{
                        obj.success(data);
                    }
                }
            }
        }
    </script>
</head>

<body>
    <div>
        Promise基础用法
    </div>
</body>
<script>
    // ajax({
    //     url: 'http://rap2.taobao.org:38080/app/mock/252985/userInfo',
    //     success(data){
    //         let user = data;
    //         console.log(user);
    //         ajax({
    //             url: 'http://rap2.taobao.org:38080/app/mock/252985/bill?userId='+user.id,
    //             success(data2){
    //                 let bill = data2;
    //                 console.log(bill);
    //             },
    //             fail(){

    //             }
    //         });
    //     },
    //     fail(){

    //     }
    // });

    // let p1 = new Promise((resolve,reject)=>{
    //     ajax({
    //         url: 'http://rap2.taobao.org:38080/app/mock/252985/userInfo',
    //         success: function(data){
    //             resolve(data)
    //         },
    //         fail: function(reason){
    //             reject(reason);
    //         }
    //     })
    // })
    
    // p1.then((val)=>{
    //     let user = val;
    //     console.log(user);

    //     let p2 = new Promise((resolve,reject)=>{
    //         ajax({
    //             url: 'http://rap2.taobao.org:38080/app/mock/252985/bill?userId='+user.id,
    //             success: function(data2){
    //                 resolve(data2)
    //             },
    //             fail: function(reason){
    //                 reject(reason);
    //             }
    //         });
    //     });

    //     return p2;

    // }).then((val)=>{
    //     console.log(val);
    // });

    let p_ajax = function(url){
        let p = new Promise((resolve,reject)=>{
            ajax({
                url: url,
                success(data){
                    resolve(data);
                },
                fail(reason){
                    reject(reason);
                }
            });
        });

        return p;
    };

    p_ajax('http://rap2.taobao.org:38080/app/mock/252985/userInfo').then((data)=>{
        let user = data;
        console.log('user',user);
        return p_ajax('http://rap2.taobao.org:38080/app/mock/252985/bill?userId='+user.id);
    }).then((data)=>{
        let bill = data;
        console.log('bill',bill);
    });

</script>

</html>